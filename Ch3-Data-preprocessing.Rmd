---
title: "Chapter 3: Data Pre-procssing"
output: html_notebook
---

# Setup

```{r}
library(tidyverse)
library(AppliedPredictiveModeling)
data("segmentationOriginal")
```

# Analysis

Filter training set samples
```{r}
segData <- segmentationOriginal %>% 
  tbl_df() %>% 
  filter(Case == "Train")
```

Save `Class`, `Cell` fields into seperate vectors, and remove from main object
```{r}
cellID <- segData %>% select(Cell)
class <- segData %>% select(Class)
case <- segData %>% select(Case)
# Remove columns
segData <- segData %>%
  select(-c(Cell, Class, Case))
```

The original data contained several “status” columns which were binary versions of the predictors. To remove these, we find the column names containing "Status" and remove them
```{r}
statusColNum <- grep("Status", names(segData))
print(statusColNum)
segData <- segData %>%
  select(-statusColNum)
```

## Transformations

Calculate sample skewness statistic for each predictor
```{r}
library(e1071)
# For one predictor
skewness(segData$AngleCh1)
```
```{r}
skewValues <- apply(segData, 2, skewness)
head(skewValues)
```

Using these values as a guide, the variables can be prioritized for visualizing
the distribution
```{r}
tibble(name = names(skewValues), skew = skewValues) %>%
  ggplot(aes(x = name, y = skew)) + geom_bar(stat = "identity") + theme(axis.text.x = element_text(angle=90, hjust=1, vjust=.5))

```

```{r}
ggplot(segData, aes(x = KurtIntenCh4)) + geom_histogram(binwidth = 1)
```

Estimate $lambda$ for Box Cox transformation using caret

```{r}
library(caret)
Ch1AreaTrans <- BoxCoxTrans(segData$AreaCh1)
Ch1AreaTrans
```

```{r}
# original data
head(segData$AreaCh1)
# after transformation
predict(Ch1AreaTrans, head(segData$AreaCh1))
(819^(-.9) - 1)/(-.9)
```


We can use base function `prcomp` for PCA

```{r}
# centering and scaling prior to PCA
pcaObject <- prcomp(segData, center = TRUE, scale. = TRUE)
#Calculate the cumulative percentage of variance which each component accounts for.
percentVariance <- pcaObject$sd^2/sum(pcaObject$sd^2)*100
percentVariance[1:3]
```

Transformed values

```{r}
head(pcaObject$x[, 1:5])
```

Variable loadings

```{r}
head(pcaObject$rotation[, 1:3])
```

Box–Cox transform, center, and scale the data, then execute PCA for signal extraction  

```{r}
trans <- preProcess(as.data.frame(segData), method = c("BoxCox", "center", "scale", "pca"))
trans
# apply transformation
transformed <- predict(trans, as.data.frame(segData))
head(transformed[, 1:5])
```

## Filtering

Filtering near-zero variance preictors
```{r}
nearZeroVar(segData)
```
No columns with near-zero predictors

Filter on between-predictor correlations
```{r}
correlations <- cor(segData)
dim(correlations)
correlations[1:4, 1:4]
```

Examine the correlation structure of the data
```{r}
library(corrplot)
# reorder to reveal clusters of highly correlated predictors
corrplot(correlations, order = "hclust")
```

Filter based on correlations; return column numbers denoting predictors recommended for deletion
```{r}
highcorr <- findCorrelation(correlations, cutoff = .75)
length(highcorr)
head(highcorr)
filteredSegData <- segData[, -highcorr]
```

## Creating dummy variables

Car dataset from `caret` package
```{r}
data("cars")
head(cars)
```

Focus on price, mileage, car type
```{r}
carSubset <- cars %>%
  gather(key = Type, value = count, ... = -(1:7)) %>%
  filter(count >= 1) %>% 
  select(Price, Mileage, Type)
head(carSubset)
```

```{r}
carSubset$Type <- as.factor(carSubset$Type)
levels(carSubset$Type)
```

Create dummy variables
```{r}
simpleMod <- dummyVars(~Mileage + Type, 
                       data = carSubset,
                       ## Remove the variable name from the column name
                       levelsOnly = TRUE)
simpleMod
```

generate the dummy variables for the training set or any new samples
```{r}
predict(simpleMod, head(carSubset))
```

Generate dummy variables with interaction between Mileage and Type
```{r}
withInteraction <- dummyVars(~Mileage + Type + Mileage:Type,
                             data = carSubset,
                             levelsOnly = TRUE)
withInteraction

predict(withInteraction, head(carSubset))
```

